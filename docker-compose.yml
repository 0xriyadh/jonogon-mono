name: jonogon-mono
services:
  mono:
    build:
      context: .
      dockerfile: Dockerfile
    working_dir: /mono
    command: pnpm run dev

    environment:
      NODE_ENV: development
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/postgres # useful for `misc/migrator`
      PORT: 12001 # `jonogon-core` port
      COMMON_HMAC_SECRET: tomato-is-a-fruititable
      COMMON_ENCRYPTION_SECRET: tomtato-is-an-actual-plant

    ports:
      - target: 12001 # `jonogon-core` HTTP port
        published: 12001
        protocol: tcp

      - target: 14001 # `jonogon-core` debugger port
        published: 14001
        protocol: tcp

      - target: 12002 # `jonogon-web` HTTP port
        published: 12002
        protocol: tcp

    volumes:
      - source: .
        target: /mono
        type: bind

      - source: mono-pnpm-store
        target: /mono/.pnpm-store
        type: volume

    depends_on:
      - postgres
      - redis

  postgres:
    image: postgres:16.4-alpine3.20
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: postgres
    ports:
      - target: 5432
        published: 5433 # changed; in case you have a local postgres running
        protocol: tcp
    volumes:
      - target: /var/lib/postgresql/data
        source: postgres-data
        type: volume

  redis:
    image: bitnami/redis:6.2
    environment:
      ALLOW_EMPTY_PASSWORD: yes
    ports:
      - target: 6379
        published: 6380 # changed; in case you have a local redis running
        protocol: tcp
    volumes:
      - target: /bitnami/redis/data
        source: redis-data
        type: volume

volumes:
  # named volumes; they aren't removed on `docker compose down`
  mono-pnpm-store:
  postgres-data:
  redis-data:
